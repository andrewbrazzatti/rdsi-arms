<link rel="stylesheet" type="text/css" href="$portalPath/css/arms-request.css" />

## toggle isFunded and fundingInfoTable
## The section has label and knockout table, has a special class: .fundinginfoSec but has no ID
<script type="text/javascript">
function toggleFundingInfo() {
	if($('input[name=isFunded]:radio:checked').val() == "Yes" ) {
		$(".fundinginfoSec").show();
	} else {
		$(".fundinginfoSec").hide();
	}
}

function copyCustodianToManager(prefix) {
	var fields =["title","givenName","familyName","organization","email","phone","role","state"];
	var el, i;
	for (i=0; i<fields.length; i++) {
		el = document.getElementById(prefix+":"+fields[i]);
		el.value = document.getElementById("dataprovider:"+fields[i]).value;
	}
	if (el = document.getElementById(prefix+":state:prefLabel")) {
		// also copy :state:prefLabel when it exists
		el.value = document.getElementById("dataprovider:state:prefLabel").value;
	}
}

// Check if all checkbox are checked
function allChecked(eid) {
	return jQuery("input[id^='"+eid+"']:checked").length == jQuery("input[id^='"+eid+"']").length
}

// This happens after jaffa binding data and triggering changes. If binding applies at that time,
// dropdown-list is not ready, we have a problem.
// This binding only when there is the checkbox useCustodianDetials
// Or simply missed change event
var bApplyEventBindings = window.setInterval(function() {
	if($('.jaffa2Loading').length == 0) {
		toggleFundingInfo();
		$('input[name=isFunded]:radio').change(toggleFundingInfo);		

		window.clearInterval(bApplyEventBindings);
	}
},500); 

function getUserAttributes(prefix) {
	var attributes = ['commonName','email'];
	jQuery.ajax({
		dataType:"json",
		url: "$portalPath/userinfo.ajax",
		success: function(attrbs) {
			for (var i = 0; i < attributes.length; i++)	{
				if (attrbs.hasOwnProperty(attributes[i])) {
					switch (attributes[i])
					{
						case "commonName":
							var val = attrbs[attributes[i]];
							var re = /\s/;
							var nameParts = val.split(re);
							jQuery("[id='"+prefix+":givenName']").val(nameParts[0]);
							jQuery("[id='"+prefix+":familyName']").val(nameParts[1]);
							break;
						case "email":
							jQuery("[id='"+prefix+":email']").val(attrbs[attributes[i]]);
							break;
					}
				}
			}
		},
		error: function (req ) { alert("Attention is needed:\n" + req.responseText) }
	});
}

$(document).ready(function() {
	$(".arms-accordion-group").accordion({
	        autoHeight:true,
	        clearStyle:true,
	        active:false,
	        collapsible:true,
	        header:".inline-block-component"
	});
	
	// Use AAF info
	jQuery("[id='dataprovider:useAAFDetials']").click(function() {
		getUserAttributes('dataprovider');
	});
	jQuery("[id='requester:useAAFDetials']").click(function() {
		getUserAttributes('requester');
	});
	jQuery("[id='nodecontact:useAAFDetials']").click(function() {
		getUserAttributes('nodecontact');
	});

	// Copy Custodian information
	jQuery("[id='requester:useCustodianDetials']").click(function() {
		copyCustodianToManager('requester');
	});

	jQuery("[id='nodecontact:useCustodianDetials']").click(function() {
		copyCustodianToManager('nodecontact');
	});
	
});

</script>								   	    
