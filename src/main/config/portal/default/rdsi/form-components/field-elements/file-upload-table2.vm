<div id="$tableName" data-bind="stopBindings: true">
<table>
    <thead>
    	<tr>
        <th>File name</th>
        <th>Description</th>
        <th>Date added</th>
        <th>Added by</th>
        <th>Actions</th>
        </tr>
        
    </thead>
    <tbody data-bind="foreach: rows">
        <tr>
        	<td><a data-bind="text: filename, attr: {href: url} " target="_upload" ></a></td>
        	 <td data-bind="text: description"/>	
        	 <td data-bind="text: dateAdded"/>
	    	 <td data-bind="text: addedBy"/>
            <td><a href="#" data-bind="click: $parent.remove">Remove</a> </td>
        </tr>
    </tbody>
</table>
</div>

<script>
startupCompleteListeners.push("initialise_$modelName")

function initialise_$modelName() {
	var rows = [];
	var prefix = "$metadataPrefix";
	for(key in jaffa.serverData) {
		 if(key.indexOf(prefix+".") == 0) {
		 	var suffix = key.substring(prefix.length+1, key.length); 
		 	var index = suffix.substring(0, suffix.indexOf("."));
		 	var ending = suffix.substring(suffix.indexOf(".")+1,suffix.length);
		 	
		 	if(rows[index-1] == null) {
		 		rows[index-1] = new Object();
		 		rows[index-1]["modelIdentifier"] = guid();
		 	}
		 	rows[index-1][ending] = jaffa.serverData[key];
		 }
	}
	
	for(var i =0; i<rows.length; i++) {
		${modelName}.rows.push(rows[i]);
	}
	
	${modelName}.rows.subscribe(function(rowArray) {
    	//delete all the old values out of serverData as some might have been deleted in the table
    	for(key in jaffa.serverData) {
			var prefix = "$metadataPrefix";
			 if(key.indexOf(prefix+".") == 0) {
			 	delete jaffa.serverData[key];
			 }
	    }
    		for(var i =1; i<=rowArray.length; i++) {
    			var row = rowArray[i-1];
    			for(key in row) {
    			  if(key != "modelIdentifier") {
    			  	jaffa.serverData[prefix+"."+i+"."+key] = row[key];
    			  }
    			}
    		}
		});
}

function $modelName() {
    var self = this;
  	self.dateAdded = ko.observable();
    self.addedBy = ko.observable();
    self.rows = ko.observableArray([]);

    self.remove = function() {
        self.rows.remove(this);
    };
}

function add${modelName}Row(model) {
    jQuery.getJSON('$portalPath/servertime.script?format=YYYY-MM-dd', function(data) {
        model['dateAdded'] = data.date;
        model['addedBy'] = '$page.authentication.get_name()';

      ${modelName}.rows.push(model);
    });

}

var $modelName = new $modelName();
ko.applyBindings($modelName, $("[id='$tableName']")[0]);

ko.applyBindingsToNode($("[id='$tableName']")[0], 
	{ click: function () { 	add${modelName}Row(); } }, $modelName 
);
</script>